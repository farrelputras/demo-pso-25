---
name: Deploy Next.js App to AWS EC2

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  NODE_VERSION: "22"
  APP_NAME: "demo-crud-app"
  DEPLOY_PATH: "/home/ubuntu/deploy"

jobs:
  build-and-deploy:
    name: "Build and Deploy to AWS EC2"
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ./package-lock.json

      # Step 3: Install dependencies and build Next.js
      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production
          # Replace this with your actual environment variables
          MONGODB_URL: ${{ secrets.DATABASE_URL }}

      # Step 4: Compress build files for transfer
      - name: Archive production build
        run: |
          tar -czf app.tar.gz .next package.json package-lock.json public

      # Step 5: Deploy to AWS EC2 using SSH
      - name: Deploy to AWS EC2
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "app.tar.gz"
          target: "/home/ubuntu/"

      # Step 6: SSH into EC2 and restart app
      - name: Restart App on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -xe

            echo "ğŸš€ Starting deployment process on EC2..."

            # Step 1: Ensure deploy directory exists
            echo "ğŸ“ Ensuring deploy directory exists: ${{ env.DEPLOY_PATH }}"
            mkdir -p ${{ env.DEPLOY_PATH }}

            # Step 2: Clean previous build
            echo "ğŸ§¹ Cleaning previous build files..."
            rm -rf ${{ env.DEPLOY_PATH }}/*

            # Step 3: Extract new build
            echo "ğŸ“¦ Extracting uploaded build archive..."
            tar -xzf /home/ubuntu/app.tar.gz -C ${{ env.DEPLOY_PATH }}

            # Step 4: Move into deploy directory
            echo "ğŸ“‚ Navigating to deploy directory..."
            cd ${{ env.DEPLOY_PATH }}
            echo "âœ… Current directory: $(pwd)"

            # Step 5: Install dependencies
            echo "ğŸ“¦ Installing npm dependencies (omit dev)..."
            npm install --omit=dev

            # Step 6: Ensure PM2 is installed
            echo "ğŸ”§ Checking PM2 installation..."
            if ! command -v pm2 &> /dev/null
            then
              echo "âš™ï¸ PM2 not found â€” installing globally..."
              sudo npm install -g pm2
            else
              echo "âœ… PM2 already installed."
            fi

            # Step 7: Restart or start the app
            echo "ğŸš€ Restarting or starting PM2 app: ${{ env.APP_NAME }}"
            if pm2 list | grep -q ${{ env.APP_NAME }}
            then
              echo "â™»ï¸ Restarting existing app..."
              pm2 restart ${{ env.APP_NAME }}
            else
              echo "âœ¨ Starting new app process..."
              pm2 start npm --name "${{ env.APP_NAME }}" -- start
            fi

            # Step 8: Save PM2 configuration
            echo "ğŸ’¾ Saving PM2 process list for startup on reboot..."
            pm2 save

            echo "âœ… Deployment completed successfully!"
